<odoo>
  <data>
    <!-- explicit list view definition -->

    <record model="ir.ui.view" id="sale_order_user_approve_limit">
      <field name="name">sale.order.user_approve_limit_form</field>
      <field name="model">sale.order</field>
      <field name="priority">98</field>
      <field name="inherit_id" ref="sale.view_order_form"/>
      <field name="arch" type="xml">
          
        <xpath expr="//button[@name='action_quotation_send'][1]" position="after">
          <button name="request_approval" type="object" string="Request Approval" class="btn-primary" attrs="{'invisible':[
            '|', '|', ('approve_limit_diff', '&gt;', '0.00'), ('state', '!=', 'draft'), ('approval_request_status', '!=', False)
          ]}" help="Quotation limit exceed user amount approval"
          context="{'approval_category': 'Sales Order', 'model_name':'sale.order'}"
          />
        </xpath>

        <xpath expr="//button[@name='action_quotation_send'][1]" position="attributes">
          <attribute name="states"></attribute>
          <attribute name="attrs">{'invisible':[
            '|',
              '&amp;',
                ('approval_request_status', '!=', 'approved'),
                ('approve_limit_diff', '&lt;', '0.00'),
              ('state', '!=', 'draft' )
          ]}</attribute>
        </xpath>

        <xpath expr="//button[@name='action_quotation_send'][2]" position="attributes">
          <attribute name="attrs">{'invisible':[
            '|',
              '|',
                ('state', '!=', 'draft'),
                ('invoice_count','&gt;=',1),
              '&amp;',
                ('approve_limit_diff', '&lt;', '0.00'),
                ('approval_request_status', '!=', 'approved')
          ]}</attribute>
        </xpath>


        <xpath expr="//button[@name='action_quotation_send'][3]" position="attributes">
          <attribute name="attrs">{'invisible':[
            '|',
              '|',
                ('state', '=', 'draft'),
                ('invoice_count','&gt;=',1),
              '&amp;',
                ('approve_limit_diff', '&lt;', '0.00'),
                ('approval_request_status', '!=', 'approved')
          ]}</attribute>
        </xpath>

        <xpath expr="//button[@name='action_quotation_send'][4]" position="attributes">
          <attribute name="states"></attribute>
          <attribute name="attrs">{'invisible':[
            '|',
              '&amp;',
                ('approve_limit_diff', '&lt;', '0.00'),
                ('approval_request_status', '!=', 'approved'),
              ('state', 'not in', ['sent','sale'] )
            ]}</attribute>
        </xpath>

        <xpath expr="//button[@name='preview_sale_order']" position="attributes">
          <attribute name="attrs">{'invisible':[
            ('approve_limit_diff', '&lt;', '0.00'), ('approval_request_status', '!=', 'approved'),
          ]}</attribute>
        </xpath>

        <xpath expr="//button[@name='action_confirm'][1]" position="attributes">
          <attribute name="string">Confirm1</attribute>
          <attribute name="attrs">{'invisible':[
            '|', '&amp;', ('approval_request_status', '!=', 'approved'), ('approve_limit_diff', '&lt;', '0.00'), ('state', 'not in', ['sent'])
          ]}</attribute>
        </xpath>

        <xpath expr="//button[@name='action_confirm'][2]" position="attributes">
          <attribute name="attrs">{'invisible':[
            '|',
                '&amp;',
                    ('approve_limit_diff', '&lt;', '0.00'),
                    ('approval_request_status', '!=', 'approved'),
                ('state', 'not in', ['draft'])
          ]}</attribute>
        </xpath>

        <xpath expr="//group[@name='sale_header']" position="before">
          <group name="approval_request_group" attrs="{'invisible':[('approve_limit_diff', '&gt;', '0.00')]}">
          <!-- <group name="approval_request_group" attrs="{'invisible':[('approval_request','=', False)]}"> -->
            <group>
              <field name="approve_limit_user" string="User &quot;Sales Document&quot; Limit" />
              <field name="approve_limit_diff" invisible="1"/>   
              <field name="approval_request" groups="sales_team.group_sale_manager"/>
              <field name="approval_request" groups="!sales_team.group_sale_manager" readonly="1"
                help="Document related to get the approval"
              />
              <field name="approval_request_status" help="Status of the requested approval"/>
            </group>
          </group>

          <script>

            $(document).ready( async () => {
                console.log("============READY");
                async function f1(seconds) {
                  let promise = new Promise(
                     (resolve, reject) => {
                        setTimeout(
                           () => resolve(true),
                           seconds
                        );
                     }
                  )

                  return promise
                }

                if ( self.odoo.session_info.is_admin ){
                    return
                }

                async function hide_elements(){
                  await f1(100);

                  approval_request_status = document.getElementsByName("approval_request_status")[0].attributes['raw-value'].value

                  request_approval_visible = document.getElementsByName("request_approval")[0].offsetParent;
                  if ( request_approval_visible != null &amp;&amp; approval_request_status != "approved") {
                    try{
                      document.getElementsByClassName("o_cp_action_menus")[0].hidden = true;
                    }catch(err){}
                  }

                  if ( approval_request_status != "false" &amp;&amp; approval_request_status != "approved") {
                    try{
                      document.getElementsByClassName("o_cp_action_menus")[0].hidden = true;
                    }catch(err){}
                  }

                }

                await hide_elements();

            })

          </script>

        </xpath>

      </field>
    </record>

  </data>
</odoo>